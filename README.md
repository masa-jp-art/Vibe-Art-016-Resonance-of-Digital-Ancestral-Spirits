# README.md

## 概要
**デジタル祖霊の共鳴 / Digital Ancestral Resonance** は、p5.js を用いた抽象的ビジュアルと、OpenAI API を介した祖霊（AI）との対話を組み合わせた、**Web上で鑑賞可能な没入型インタラクティブアート**です。
- フロー・フィールド＋粒子で「見えない流れ」を可視化。
- マイクからの**環境音/声**に**リアルタイム同期**（FFT相当の簡易バンド解析）。
- 祖霊（AI）の発話時に**光が脈動**。
- カメラ（任意）で場の明るさを取り込み、色味や流れに微影響。
- チャットUIで哲学的・詩的な対話体験。
- **不気味の谷**を避けるため、半具象の**光のアバター**表現を採用。

> 倫理的配慮：本作の「祖霊」は**シミュラクラ（模倣）**です。実在の故人そのものではありません。

---

## セットアップ

### 1) 依存関係のインストール
```bash
npm i

### 2) 環境変数を設定

`.env.example` をコピーして `.env` を作成し、OpenAIのAPIキーを記入します。

```bash
cp .env.example .env
# .env を編集して OPENAI_API_KEY を設定

```

### 3) 起動

```bash
npm run dev

```

ブラウザで [**http://localhost:3000**](http://localhost:3000/) を開きます。

> 重要: マイク／カメラは https か localhost でのみ動作します。
> 
> 
> `file:///.../index.html` を直接開くと、
> 
> 「**Not allowed to load local resource: blob:null...**」や
> 
> 「**Unable to load a worklet's module**」等のエラーが出ます。
> 
> 必ず上記のローカルサーバで起動してください。
> 

---

## 体験方法

1. ページを開くと、暗い空間に**光の粒子の流れ**が現れます。
2. 右上の **「🎙 マイク有効化」** を押して許可すると、環境音／声に反応して映像が変化します。
3. （任意）**「📷 カメラ有効化」** を押すと、場の明るさが色調・流れにわずかに影響します（映像そのものは表示しません）。
4. 下部のチャットにことばを入力して送信すると、祖霊（AI）が**短い詩のような声**で応じます。発話に合わせて**中心の光が脈動**します。
5. **Hキー**でチャットUIの表示/非表示を切り替え、**没入鑑賞**も可能です。

---

## 実装の要点

### フロント（`index.html` / `style.css` / `sketch.js`）

- p5.js（**p5.soundは不使用**）＋ **Web Audio API** でマイク入力を解析。
- **AnalyserNode** を使い `getByteFrequencyData()` の周波数分布から **低/中/高域**の強度を算出。
- **フロー・フィールド**：Perlin ノイズ（`noise(x,y,t)`）から角度場を生成し、多数の粒子に流れを与える。残像（半透明の黒塗り）で**発光・ブラー**のような質感を演出。
- **アバター**：中心に多層の加算合成円を重ね、音量＆対話イベントで半径と輝度が**脈動**。
- **カメラ**（任意）：非表示のビデオから平均輝度のみ抽出→色相偏移や角度の微バイアスに使用。
- **アクセシビリティ**：UIは常時テキスト表示／Hキーで非表示可。動きに敏感な環境でもマイクをOFFにすれば静的に鑑賞可能。

### サーバ（`server.js`）

- **Express** で静的配信＋ `/api/chat` を実装。
- **.env の `OPENAI_API_KEY`** で OpenAI API を安全にプロキシ（クライアントへキーを露出しない）。
- 既定モデルは `OPENAI_MODEL`（未設定なら `gpt-3.5-turbo`）。

### クライアント→AI通信（`openai.js`）

- 会話履歴 `messages` を `/api/chat` に送信→ OpenAI Chat Completions を呼び出し。
- 祖霊の応答テキストを表示し、**視覚パルス**をトリガ（`window.bumpPulse()`）。

---

## トラブルシューティング

### Q. コンソールに *Not allowed to load local resource: blob:null...* / *Unable to load a worklet's module* と出る

- **原因**：`file://` で直接開いている、または**安全なオリジン**（https/localhost）でないため、AudioWorklet/Blob の読み込みや getUserMedia がブロックされています。
- **解決**：本プロジェクトの **`server.js` を起動**し、`http://localhost:3000` からアクセスしてください。

### Q. マイクが動かない

- ブラウザがマイク権限をブロックしている可能性。アドレスバーの権限アイコンから許可。
- 他アプリでマイクが占有されていないか確認。
- それでも不可なら、一度 `btnMic` を再クリックして AudioContext を `resume()`。

### Q. OpenAI の応答がこない

- ターミナルに **OPENAI_API_KEY が無い**等のエラーが出ていないか確認。
- `.env` を正しく作成し `npm run dev` を再起動。
- モデル名を `.env` の `OPENAI_MODEL` で切り替えて試す。

---

## 倫理・プライバシー

- **マイク／カメラの生データはサーバへ送信しません**（ローカルで解析）。
- AIのことばは**模倣**であり、実在の故人の人格を保証するものではありません。
- 心理的な負荷を避けるため、強いパルス演出は短時間で減衰。HキーでUIを隠せます。

---

## 拡張のアイデア

- 反応拡散（Gray-Scott）を GPU/CPU で追加し、音パラメータをモデルにマッピング。
- TTS（読み上げ）と残響を加え、**声の空間性**を強化。
- ユーザーのテキストから「記憶の断片」カードを生成し、粒子に乗せて漂わせる。

---

© 2025 Digital Ancestral Resonance – This project is an art experiment exploring memory, presence, and digital spirituality.